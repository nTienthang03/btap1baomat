<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Mã Playfair</title>
    <style>
        body { font-family: Arial; }
        input, button { margin: 5px; }
        #output { color: green; }
    </style>
</head>
<body>
    <h2>Mã Playfair</h2>
    <input type="text" id="text" placeholder="Nhập văn bản">
    <input type="text" id="key" placeholder="Khóa" value="MONARCHY">
    <button onclick="encrypt()">Mã hóa</button>
    <button onclick="decrypt()">Giải mã</button>
    <p id="output"></p>

    <script>
        class Playfair {
            constructor(key) {
                this.table = this.buildTable(key.toUpperCase());
            }

            buildTable(key) {
                const alphabet = 'ABCDEFGHIKLMNOPQRSTUVWXYZ';  // No J
                let used = '';
                for (let c of key) {
                    if (c === 'J') c = 'I';
                    if (alphabet.includes(c) && !used.includes(c)) used += c;
                }
                used += alphabet.split('').filter(c => !used.includes(c)).join('');
                const table = [];
                for (let i = 0; i < 5; i++) {
                    table.push(used.slice(i*5, (i+1)*5).split(''));
                }
                return table;
            }

            findPos(c) {
                if (c === 'J') c = 'I';
                for (let i = 0; i < 5; i++) {
                    for (let j = 0; j < 5; j++) {
                        if (this.table[i][j] === c) return [i, j];
                    }
                }
                return [-1, -1];
            }

            prepareText(text) {
                text = text.toUpperCase().replace(/[^A-Z]/g, '').replace(/J/g, 'I');
                let prepared = '';
                for (let i = 0; i < text.length; i += 2) {
                    prepared += text[i];
                    if (i + 1 === text.length) {
                        prepared += 'X';
                    } else if (text[i] === text[i+1]) {
                        prepared += 'X';
                        i--;
                    } else {
                        prepared += text[i+1];
                    }
                }
                return prepared;
            }

            shift(text, encrypt = true) {
                text = this.prepareText(text);
                let result = '';
                const dir = encrypt ? 1 : -1;
                for (let i = 0; i < text.length; i += 2) {
                    let [r1, c1] = this.findPos(text[i]);
                    let [r2, c2] = this.findPos(text[i+1]);
                    if (r1 === r2) {
                        result += this.table[r1][(c1 + dir + 5) % 5];
                        result += this.table[r2][(c2 + dir + 5) % 5];
                    } else if (c1 === c2) {
                        result += this.table[(r1 + dir + 5) % 5][c1];
                        result += this.table[(r2 + dir + 5) % 5][c2];
                    } else {
                        result += this.table[r1][c2];
                        result += this.table[r2][c1];
                    }
                }
                return result;
            }
        }

        function encrypt() {
            const text = document.getElementById('text').value;
            const key = document.getElementById('key').value;
            const pf = new Playfair(key);
            document.getElementById('output').innerText = 'Mã hóa: ' + pf.shift(text);
        }

        function decrypt() {
            const text = document.getElementById('text').value;
            const key = document.getElementById('key').value;
            const pf = new Playfair(key);
            document.getElementById('output').innerText = 'Giải mã: ' + pf.shift(text, false);
        }
    </script>
</body>
</html>